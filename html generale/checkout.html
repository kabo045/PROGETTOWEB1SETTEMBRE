<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Checkout Pagamento</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/try.css">

 <style>
    .pay-method.selected { border: 2px solid #0033aa; background: #f0f4ff; }
    .pay-method { cursor: pointer; border: 1.5px solid #d6d6d6; border-radius: 8px; margin-bottom: 10px; transition: border 0.2s; min-width: 90px; }
    .pay-method-logo { width: 40px; height: 30px; object-fit: contain; margin-bottom: 4px; }
    .card-details { display: none; }
    #toast-container { position: fixed; top: 18px; right: 20px; z-index: 12000; }
  </style>
</head>
<body class="bg-light">
<div class="container py-5">
  <div id="toast-container"></div>
  <div class="row justify-content-center">
    <!-- Bottone Torna a prenota_cliente.html -->
    <a href="prenota_cliente.html" class="btn btn-outline-secondary mb-3" style="font-size:1.1rem;">
      <i class="bi bi-arrow-left"></i> Torna alla prenotazione
    </a>

    <div class="col-lg-6 col-md-8">
      <h2 class="mb-4 text-center">Completa il Pagamento</h2>
      <div id="prenotazioneBox" class="mb-4"></div>
      <form id="formPagamento" autocomplete="off" novalidate>
        <div>
          <label class="mb-2">Scegli il metodo di pagamento:</label>
          <div id="methodBox" class="d-flex flex-wrap gap-3 mb-3"></div>
        </div>
        <div class="card-details">
          <label class="form-label">Numero Carta</label>
          <input type="text" class="form-control mb-2" id="ccNumber" name="ccNumber"
            maxlength="19" placeholder="1234 5678 9012 3456"
            pattern="^(\d{4}\s?){4}$" autocomplete="cc-number">
          <label class="form-label">Nome intestatario</label>
          <input type="text" class="form-control mb-2" id="ccName" name="ccName" maxlength="40" placeholder="NOME COGNOME">
          <div class="row">
            <div class="col-6">
              <label class="form-label">Scadenza (MM/AA)</label>
              <input type="text" class="form-control" id="ccExp" name="ccExp" maxlength="5" placeholder="08/27">
            </div>
            <div class="col-6">
              <label class="form-label">CVV</label>
              <input type="password" class="form-control" id="ccCvv" name="ccCvv" maxlength="4" placeholder="123">
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary mt-4 w-100">Paga ora</button>
      </form>
    </div>
  </div>
</div>
<script>
const token = localStorage.getItem("token");
if (!token) window.location.href = "login.html";

let currentBooking = null;

const payMethods = [
  { id: "Carta", label: "Visa", logo: "https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" },
  { id: "Mastercard", label: "MasterCard", logo: "https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" },
  { id: "PayPal", label: "PayPal", logo: "https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" },
  { id: "ApplePay", label: "Apple Pay", logo: "https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" },
  { id: "Bonifico", label: "Bonifico", logo: "https://cdn-icons-png.flaticon.com/512/1999/1999173.png" }
];

function showToast(msg, type="success") {
  const toast = document.createElement("div");
  toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${msg}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;
  document.getElementById("toast-container").appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

async function caricaPrenotazione() {
  const params = new URLSearchParams(window.location.search);
  const bookingId = params.get("booking");
  let bookings = [];
  const res = await fetch("/api/cliente/bookings", { headers: { Authorization: `Bearer ${token}` } });
  bookings = await res.json();
  if (bookingId) {
    currentBooking = bookings.find(b => String(b.id) === bookingId);
  } else {
    currentBooking = bookings.find(b => !b.payment_status || b.payment_status !== "completato");
  }
  if (!currentBooking) {
    document.getElementById("prenotazioneBox").innerHTML = '<div class="alert alert-success">Nessuna prenotazione da pagare!<br><a href="dashboard_cliente.html" class="btn btn-link mt-2">Torna alla dashboard</a></div>';
    document.getElementById("formPagamento").style.display = "none";
    return;
  }
  const importo = (currentBooking.booking_amount ?? currentBooking.amount ?? '--');
  document.getElementById("prenotazioneBox").innerHTML = `
    <div class="mb-2"><b>Sede:</b> ${currentBooking.location_name ?? ''}</div>
    <div class="mb-2"><b>Spazio:</b> ${currentBooking.space_type ?? ''} - <b>Postazione:</b> ${currentBooking.workstation_name ?? ''}</div>
    <div class="mb-2"><b>Data:</b> ${currentBooking.date ?? ''} <b>Ora:</b> ${currentBooking.time_slot ?? ''}</div>
    <div class="fs-5 mt-2 mb-2"><b>Importo:</b> <span class="text-primary">â‚¬${isNaN(Number(importo)) ? '--' : Number(importo).toFixed(2)}</span></div>
  `;
}

function renderPayMethods() {
  const box = document.getElementById("methodBox");
  box.innerHTML = payMethods.map(m => `
    <div class="pay-method p-2 px-3 d-flex flex-column align-items-center" tabindex="0" data-method="${m.id}" onclick="selectMethod('${m.id}')">
      <img src="${m.logo}" alt="${m.label}" class="pay-method-logo mb-1"/>
      <span style="font-size: 0.97rem;">${m.label}</span>
    </div>
  `).join("");
  selectMethod("Carta");
}

window.selectMethod = function(methodId) {
  document.querySelectorAll('.pay-method').forEach(el => {
    if (el.dataset.method === methodId) el.classList.add('selected');
    else el.classList.remove('selected');
  });
  // Mostra i campi carta solo se serve
  const showCardFields = (methodId === "Carta" || methodId === "Mastercard");
  document.querySelector('.card-details').style.display = showCardFields ? "block" : "none";
  // Abilita/disabilita required+disabled sui campi carta
  document.querySelectorAll('.card-details input').forEach(input => {
    if (showCardFields) {
      input.removeAttribute('disabled');
      input.setAttribute('required', '');
    } else {
      input.setAttribute('disabled', 'disabled');
      input.removeAttribute('required');
      input.value = ""; // pulisci i dati carta se cambi metodo
    }
  });
  document.getElementById("formPagamento").dataset.method = methodId;
}

// Format automatico con spazio ogni 4 cifre
document.getElementById("ccNumber").addEventListener("input", function(e) {
  let val = this.value.replace(/\D/g, ""); // solo numeri
  val = val.substring(0,16); // massimo 16 cifre
  this.value = val.replace(/(.{4})/g, "$1 ").trim();
});

document.getElementById("formPagamento").onsubmit = async function(e) {
  e.preventDefault();
  const method = this.dataset.method || "Carta";
  if (!currentBooking) return;

  // Validazione per carte (Visa/Mastercard)
  if (method === "Carta" || method === "Mastercard") {
    const ccNumber = document.getElementById("ccNumber").value.replace(/\s/g, '');
    const ccName = document.getElementById("ccName").value.trim();
    const ccExp = document.getElementById("ccExp").value.trim();
    const ccCvv = document.getElementById("ccCvv").value.trim();

    if (!ccNumber.match(/^\d{16}$/)) {
      showToast("Numero carta non valido! Deve essere di 16 cifre.", "danger");
      document.getElementById("ccNumber").focus();
      return;
    }
    if (method === "Mastercard" && !ccNumber.startsWith("5")) {
      showToast("Per Mastercard la carta deve iniziare per 5!", "danger");
      document.getElementById("ccNumber").focus();
      return;
    }
    if (method === "Carta" && !ccNumber.startsWith("4")) {
      showToast("Per Visa la carta deve iniziare per 4!", "danger");
      document.getElementById("ccNumber").focus();
      return;
    }
    if (!ccName.match(/^[A-Z ]+$/i)) {
      showToast("Nome intestatario non valido!", "danger");
      document.getElementById("ccName").focus();
      return;
    }
    if (!ccExp.match(/^(0[1-9]|1[0-2])\/\d{2}$/)) {
      showToast("Scadenza non valida (MM/AA)!", "danger");
      document.getElementById("ccExp").focus();
      return;
    }
    // Verifica scadenza nel futuro
    const [mm, yy] = ccExp.split("/");
    const expDate = new Date(`20${yy}`, mm);
    const now = new Date();
    if (expDate < now) {
      showToast("Carta scaduta!", "danger");
      document.getElementById("ccExp").focus();
      return;
    }
    if (!ccCvv.match(/^\d{3,4}$/)) {
      showToast("CVV non valido!", "danger");
      document.getElementById("ccCvv").focus();
      return;
    }
  }

  // Chiamata al backend per registrare il pagamento
  const res = await fetch(`/api/cliente/bookings/${currentBooking.id}/pay`, {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
    body: JSON.stringify({ method })
  });
  const data = await res.json();
  if (res.ok) {
    showToast("Pagamento effettuato!");
    setTimeout(() => window.location.href = "pagamenti_cliente.html", 1200);
  } else {
    showToast(data.message || "Errore pagamento", "danger");
  }
}

caricaPrenotazione();
renderPayMethods();
</script>
</body>
</html>
